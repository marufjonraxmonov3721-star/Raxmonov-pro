<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AKT Quiz Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --bg: #f3f4f6; --card: #ffffff; --text: #1f2937;
            --p: #4f46e5; --gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        body.dark { --bg: #111827; --card: #1f2937; --text: #f9fafb; --shadow: 0 4px 20px rgba(0,0,0,0.4); }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; transition: 0.3s; }
        
        /* Navigatsiya */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; padding: 12px 0; border-top: 1px solid rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { cursor: pointer; text-align: center; flex: 1; font-size: 11px; color: #9ca3af; transition: 0.2s; }
        .nav-item.active { color: var(--p); font-weight: bold; }
        .nav-item i { font-size: 22px; display: block; margin-bottom: 4px; }

        .page { display: none; padding: 20px; max-width: 500px; margin: auto; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card); padding: 22px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 18px; }
        .btn-main { width: 100%; padding: 16px; background: var(--gradient); color: white; border: none; border-radius: 14px; font-weight: bold; cursor: pointer; }
        
        .option { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #e5e7eb; border-radius: 12px; background: none; color: var(--text); text-align: left; font-size: 16px; transition: 0.2s; cursor: pointer; }
        .correct { background: #d1fae5 !important; border-color: #10b981 !important; color: #064e3b !important; }
        .wrong { background: #fee2e2 !important; border-color: #ef4444 !important; color: #7f1d1d !important; }

        /* Settings Toggle */
        .switch { position: relative; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #d1d5db; border-radius: 24px; cursor: pointer; transition: 0.4s; }
        .slider:before { content: ""; position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.4s; }
        input:checked + .slider { background: var(--p); }
        input:checked + .slider:before { transform: translateX(20px); }

        .result-circle { width: 100px; height: 100px; border-radius: 50%; border: 6px solid var(--p); display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 20px; font-weight: bold; color: var(--p); }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div id="page-all" class="page active">
        <h2>Texnik tizimlarda AKT</h2>
        <div class="card" style="background: var(--gradient); color: white;">
            <h3>O'quv kursi (245 savol)</h3>
            <p>Bazadagi qat'iy tartib bo'yicha o'rganish.</p>
            <button class="btn-main" style="background: white; color: var(--p);" onclick="startMode('all')">BOSHLASH</button>
        </div>
    </div>

    <div id="page-real" class="page">
        <h2>Imtihon Markazi</h2>
        <div class="card">
            <div style="text-align: center; padding: 10px;">
                <i class="fas fa-clock" style="font-size: 40px; color: var(--p); margin-bottom: 10px;"></i>
                <h3>35 savol / 30 daqiqa</h3>
                <p>Natijangiz reytingga qo'shiladi.</p>
            </div>
            <button class="btn-main" onclick="startMode('real')">TESTNI BOSHLASH</button>
        </div>
    </div>

    <div id="page-rank" class="page">
        <h2>Top Reyting</h2>
        <div class="card" id="rank-container" style="padding: 10px;">Yuklanmoqda...</div>
    </div>

    <div id="page-settings" class="page">
        <h2>Sozlamalar</h2>
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <span>Tungi rejim</span>
                <label class="switch">
                    <input type="checkbox" id="theme-toggle" onchange="toggleDarkMode()">
                    <span class="slider"></span>
                </label>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Profil:</span>
                <b id="tg-name">Foydalanuvchi</b>
            </div>
        </div>
    </div>

    <div id="quiz-screen" class="page">
        <div class="card">
            <div style="display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 15px;">
                <span id="timer-label" style="color: #ef4444;">--:--</span>
                <span id="counter-label">0/0</span>
            </div>
            <div id="q-text" style="font-size: 18px; font-weight: 600; margin-bottom: 20px;"></div>
            <div id="options-box"></div>
        </div>
    </div>

    <div id="page-result" class="page">
        <div class="card" style="text-align: center;">
            <div class="result-circle" id="res-circle">0%</div>
            <h2 id="res-status">Natija</h2>
            <p id="res-text"></p>
            <button class="btn-main" onclick="location.reload()">MENYUGA QAYTISH</button>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="nav('page-all', this)"><i class="fas fa-book-open"></i>O'quv</div>
        <div class="nav-item" onclick="nav('page-real', this)"><i class="fas fa-bolt"></i>Test</div>
        <div class="nav-item" onclick="nav('page-rank', this); loadRankings();"><i class="fas fa-medal"></i>Reyting</div>
        <div class="nav-item" onclick="nav('page-settings', this)"><i class="fas fa-cog"></i>Sozlamalar</div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, doc, getDoc, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCavyC9nUUT4Rk2Xh2wq2rKhIGZwSr97uM",
        authDomain: "meningquizilovam.firebaseapp.com",
        projectId: "meningquizilovam",
        storageBucket: "meningquizilovam.firebasestorage.app",
        messagingSenderId: "107483720751",
        appId: "1:107483720751:web:505d527fbccbbf4ce26ada"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    let allQs = [], currentQs = [], userAnswers = [];
    let curIdx = 0, timerInt = null, mode = "";
    
    // Telegram ma'lumotlari
    const userId = tg.initDataUnsafe?.user?.id || "guest_user";
    const userName = tg.initDataUnsafe?.user?.first_name || "Foydalanuvchi";
    document.getElementById('tg-name').innerText = userName;

    window.nav = (id, el) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(el) el.classList.add('active');
        if(id !== 'quiz-screen') clearInterval(timerInt);
    };

    window.toggleDarkMode = () => {
        const isDark = document.getElementById('theme-toggle').checked;
        document.body.classList.toggle('dark', isDark);
        localStorage.setItem('aktDarkMode', isDark);
    };

    if(localStorage.getItem('aktDarkMode') === 'true') {
        document.body.classList.add('dark');
        document.getElementById('theme-toggle').checked = true;
    }

    async function loadData() {
        const snap = await getDocs(collection(db, "savollar"));
        let list = [];
        snap.forEach(d => list.push({...d.data(), t: d.data().createdAt?.seconds || 0}));
        allQs = list.sort((a,b) => a.t - b.t); // Qat'iy vaqt tartibi
    }

    window.startMode = async (m) => {
        if(allQs.length === 0) await loadData();
        mode = m; curIdx = 0; userAnswers = [];
        
        if(mode === 'real') {
            currentQs = [...allQs].sort(() => 0.5 - Math.random()).slice(0, 35);
            startTimer(30 * 60); 
        } else {
            currentQs = [...allQs];
            document.getElementById('timer-label').innerText = "üìñ O'quv";
            document.getElementById('timer-label').style.color = "var(--p)";
        }
        nav('quiz-screen');
        render();
    };

    function startTimer(sec) {
        clearInterval(timerInt);
        timerInt = setInterval(() => {
            let m = Math.floor(sec/60), s = sec%60;
            document.getElementById('timer-label').innerText = `‚è± ${m}:${s<10?'0':''}${s}`;
            if(--sec < 0) { clearInterval(timerInt); finish(); }
        }, 1000);
    }

    function render() {
        const q = currentQs[curIdx];
        document.getElementById('counter-label').innerText = `${curIdx+1}/${currentQs.length}`;
        document.getElementById('q-text').innerText = q.text;
        const box = document.getElementById('options-box');
        box.innerHTML = '';

        let opts = [...q.variants].sort(() => 0.5 - Math.random());
        let correct = q.variants[0];

        opts.forEach(opt => {
            const b = document.createElement('button');
            b.className = 'option';
            b.innerText = opt;
            b.onclick = () => {
                document.querySelectorAll('.option').forEach(btn => btn.style.pointerEvents = 'none');
                if(mode === 'all') {
                    if(opt === correct) b.classList.add('correct');
                    else {
                        b.classList.add('wrong');
                        document.querySelectorAll('.option').forEach(btn => { if(btn.innerText === correct) btn.classList.add('correct'); });
                    }
                    setTimeout(() => next(opt, correct), 1200);
                } else {
                    b.style.borderColor = "var(--p)";
                    setTimeout(() => next(opt, correct), 250);
                }
            };
            box.appendChild(b);
        });
    }

    function next(s, c) {
        userAnswers.push({s, c});
        curIdx++;
        if(curIdx < currentQs.length) render();
        else finish();
    }

    async function finish() {
        clearInterval(timerInt);
        const cor = userAnswers.filter(a => a.s === a.c).length;
        const per = Math.round((cor/currentQs.length)*100);
        const currentScore = cor * 2; // 35 * 2 = 70 max

        nav('page-result');
        document.getElementById('res-circle').innerText = per + "%";
        document.getElementById('res-text').innerText = `${currentQs.length} tadan ${cor} ta to'g'ri.`;
        
        if(per >= 60) {
            document.getElementById('res-status').innerText = "Muvaffaqiyatli! üéâ";
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        } else {
            document.getElementById('res-status').innerText = "Yana o'qing! üìö";
        }

        // REYTING YANGILASH (Faqat eng yuqori natija)
        if(mode === 'real' && userId !== "guest_user") {
            const userRef = doc(db, "reyting", userId.toString());
            const userDoc = await getDoc(userRef);
            
            if (!userDoc.exists() || currentScore > userDoc.data().score) {
                await setDoc(userRef, {
                    name: userName,
                    score: currentScore,
                    updatedAt: serverTimestamp()
                });
            }
        }
    }

    window.loadRankings = async () => {
        const q = query(collection(db, "reyting"), orderBy("score", "desc"), limit(15));
        const snap = await getDocs(q);
        const container = document.getElementById('rank-container');
        container.innerHTML = '<h3 style="margin: 0 0 10px 0; border-bottom: 2px solid var(--p); display: inline-block;">Top 15 Peshqadam</h3>';
        
        let i = 1;
        snap.forEach(d => {
            const data = d.data();
            const isMe = d.id === userId.toString() ? "background: rgba(79, 70, 229, 0.1); border-left: 4px solid var(--p);" : "";
            container.innerHTML += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 10px; margin-bottom:5px; border-radius:10px; ${isMe}">
                    <span><b style="color:var(--p)">${i++}.</b> ${data.name}</span>
                    <b style="background:var(--gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">${data.score} ball</b>
                </div>`;
        });
    };

    loadData();
</script>
</body>
</html>
