<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>Word to JSON - Image Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #0f172a; color: white; padding: 20px; text-align: center; }
        .box { border: 3px dashed #38bdf8; padding: 40px; border-radius: 20px; background: #1e293b; }
        .btn { background: #38bdf8; color: black; padding: 15px 30px; border-radius: 10px; cursor: pointer; font-weight: bold; display: inline-block; }
        #status { margin-top: 20px; color: #10b981; font-weight: bold; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div class="box">
    <h2>100% Rasm va JSON Engine</h2>
    <p>Word faylni yuklang, rasmlar avtomatik Base64 ga o'tkaziladi.</p>
    <label for="fileInput" class="btn">üìÅ FAYLNI TANLASH (.DOCX)</label>
    <input type="file" id="fileInput" accept=".docx">
    <div id="status"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = function(event) {
            const arrayBuffer = event.target.result;
            
            // RASMLARNI O'QISH UCHUN ENG KUCHLI FILTR
            const options = {
                convertImage: mammoth.images.inline(function(element) {
                    return element.read("base64").then(function(imageBuffer) {
                        return {
                            src: "data:" + element.contentType + ";base64," + imageBuffer.fallback
                        };
                    });
                })
            };

            mammoth.convertToHtml({arrayBuffer: arrayBuffer}, options).then(result => {
                const temp = document.createElement('div');
                temp.innerHTML = result.value;
                const rows = Array.from(temp.querySelectorAll('tr'));
                
                let questionsObj = {};
                
                rows.forEach((row, index) => {
                    const cols = Array.from(row.querySelectorAll('td'));
                    if (cols.length >= 5) {
                        // Savol katagidan rasmni qidirish
                        const qCell = cols[0];
                        const imgTag = qCell.querySelector('img');
                        
                        // Rasmni alohida "image" maydoniga olish
                        let base64Img = "";
                        if (imgTag) {
                            base64Img = imgTag.src;
                            imgTag.remove(); // Savol matni ichidan rasmni olib tashlash
                        }

                        // Siz so'ragan JSON strukturasi
                        questionsObj[index + 1] = {
                            "question": qCell.innerText.trim() || "Savol quyidagi rasmda:",
                            "image": base64Img, // Rasm shu yerga tushadi
                            "answers": {
                                "A": cols[1].innerText.trim(),
                                "B": cols[2].innerText.trim(),
                                "C": cols[3].innerText.trim(),
                                "D": cols[4].innerText.trim()
                            },
                            "correct": "A"
                        };
                    }
                });

                // Firebase'ga yuborish (smart_questions tuguniga)
                set(ref(db, 'smart_questions'), { "questions": questionsObj }).then(() => {
                    document.getElementById('status').innerText = "‚úÖ " + Object.keys(questionsObj).length + " ta savol va rasmlar 100% yuklandi!";
                });
            });
        };
        reader.readAsArrayBuffer(file);
    });
</script>
</body>
</html>
