<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Real-Time Leaderboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f8fafc; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 450px; background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); box-sizing: border-box; }
        .hidden { display: none; }
        .btn { background: var(--accent); border: none; padding: 12px 20px; border-radius: 8px; color: #000; font-weight: bold; cursor: pointer; width: 100%; margin-top: 15px; font-size: 16px; }
        .option-btn { background: #334155; color: white; text-align: left; margin-bottom: 10px; display: block; width: 100%; padding: 12px; border: none; border-radius: 8px; }
        .user-card { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #334155; align-items: center; }
        .user-card b { color: var(--accent); }
        .rank { width: 30px; font-weight: bold; color: #94a3b8; }
        h2, h3 { text-align: center; margin-top: 0; }
    </style>
</head>
<body>

<div class="container" id="setup-screen">
    <h2 id="welcome-user">Salom!</h2>
    <p style="text-align: center;">10 ta savolga javob bering va reytingda o'z o'rningizni egallang.</p>
    <button class="btn" onclick="startQuiz()">O'yinni boshlash</button>
</div>

<div class="container hidden" id="quiz-screen">
    <h3 id="question-text">Savol...</h3>
    <div id="options-container"></div>
</div>

<div class="container hidden" id="result-screen">
    <h3>Natijangiz: <span id="final-score">0</span> ball</h3>
    <hr style="border: 0.5px solid #334155;">
    <h3>üèÜ TOP 10 REYTING</h3>
    <div id="leaderboard"></div>
    <button class="btn" onclick="location.reload()">Qayta o'ynash</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, update, onValue, query, orderByChild, limitToLast, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Firebase sozlamalari (O'zgartirmang)
    const firebaseConfig = {
        apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
        authDomain: "gen-lang-client-0228947349.firebaseapp.com",
        databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
        projectId: "gen-lang-client-0228947349",
        storageBucket: "gen-lang-client-0228947349.firebasestorage.app",
        messagingSenderId: "253793341504",
        appId: "1:253793341504:web:709752258000dab44fcfa5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;

    // Telegramdan foydalanuvchi ma'lumotlarini olish
    const user = tg.initDataUnsafe?.user || { id: "test_user", first_name: "Mehmon" };
    document.getElementById('welcome-user').innerText = `Salom, ${user.first_name}!`;
    tg.expand(); // Ekranini to'liq ochish

    const questions = [
        { q: "O'zbekiston poytaxti?", a: ["Toshkent", "Samarqand"], c: 0 },
        { q: "HTML nima?", a: ["Dasturlash tili", "Belgilash tili"], c: 1 },
        { q: "2x2 necha?", a: ["4", "5"], c: 0 },
        { q: "Eng katta sayyora?", a: ["Mars", "Yupiter"], c: 1 },
        { q: "Eng tez hayvon?", a: ["Gepard", "Sher"], c: 0 },
        { q: "Telegram asoschisi?", a: ["Pavel Durov", "Elon Musk"], c: 0 },
        { q: "Quyosh qachon chiqadi?", a: ["Kechasi", "Ertalab"], c: 1 },
        { q: "Dunyodagi eng uzun daryo?", a: ["Nil", "Amazonka"], c: 0 },
        { q: "Futbol maydonida nechta o'yinchi bo'ladi?", a: ["11", "22"], c: 0 },
        { q: "O'zbekiston bayrog'ida nechta yulduz bor?", a: ["12", "10"], c: 0 }
    ];

    let currentIdx = 0, score = 0;

    window.startQuiz = () => {
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        showQuestion();
    };

    function showQuestion() {
        const q = questions[currentIdx];
        document.getElementById('question-text').innerText = `${currentIdx + 1}. ${q.q}`;
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        q.a.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => {
                if (i === q.c) score += 10;
                currentIdx++;
                currentIdx < questions.length ? showQuestion() : finishQuiz();
            };
            container.appendChild(btn);
        });
    }

    async function finishQuiz() {
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('final-score').innerText = score;

        // Bazadagi eski natijani tekshirish (faqat rekordni yangilash uchun)
        const userRef = ref(db, 'leaderboard/' + user.id);
        const snapshot = await get(userRef);
        const oldData = snapshot.val();

        if (!oldData || score > oldData.score) {
            await update(userRef, {
                username: user.first_name + (user.last_name ? " " + user.last_name : ""),
                score: score,
                timestamp: Date.now()
            });
        }
        loadLeaderboard();
    }

    function loadLeaderboard() {
        const topRef = query(ref(db, 'leaderboard'), orderByChild('score'), limitToLast(10));
        onValue(topRef, (snap) => {
            const board = document.getElementById('leaderboard');
            board.innerHTML = '';
            let list = [];
            snap.forEach(s => list.push(s.val()));
            list.sort((a, b) => b.score - a.score).forEach((u, i) => {
                board.innerHTML += `
                    <div class="user-card">
                        <span class="rank">${i+1}</span>
                        <span style="flex-grow:1">${u.username}</span>
                        <b>${u.score} ball</b>
                    </div>`;
            });
        });
    }
</script>
</body>
</html>
