<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Quiz - Fixed Version</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { background: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif; padding-bottom: 90px; }
        .screen { display: none; } 
        .screen.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #chat-messages { height: 280px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .msg { margin: 5px 0; padding: 10px 14px; border-radius: 18px; max-width: 85%; font-size: 13px; line-height: 1.4; }
        .my-msg { background: #2563eb; align-self: flex-end; color: white; border-bottom-right-radius: 2px; }
        .other-msg { background: white; align-self: flex-start; color: #1e293b; border-bottom-left-radius: 2px; border: 1px solid #e2e8f0; }
        .opt-btn { background: white; border: 2px solid #e2e8f0; border-radius: 16px; padding: 14px; width: 100%; text-align: left; transition: 0.2s; font-weight: 600; color: #334155; }
        .correct { border-color: #22c55e !important; background: #f0fdf4 !important; color: #166534; }
        .wrong { border-color: #ef4444 !important; background: #fef2f2 !important; color: #991b1b; }
        .selected-real { border-color: #3b82f6; background: #eff6ff; }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto p-4">
    <div class="bg-white p-4 rounded-[2rem] shadow-sm mb-4 border border-slate-100">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center text-green-600 font-extrabold text-[10px] uppercase">
                <i class="fas fa-users mr-2"></i> ONLAYN: <span id="online-count">0</span>
            </div>
            <button onclick="toggleChat()" class="bg-slate-900 text-white px-5 py-2 rounded-full text-[10px] font-black shadow-lg">CHAT</button>
        </div>
        <div id="online-list" class="flex flex-wrap gap-1 mb-2"></div>
        <div id="chat-ui" class="hidden border-t pt-4 mt-2">
            <div id="chat-messages" class="mb-3 space-y-2 p-3 bg-slate-50 rounded-2xl border"></div>
            <div class="flex gap-2">
                <input id="chat-input" type="text" placeholder="Xabar..." class="flex-1 bg-white border rounded-xl px-4 py-3 text-xs outline-none">
                <button onclick="sendMsg()" class="bg-blue-600 text-white p-3 rounded-xl w-12 shadow-md"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <section id="page-home" class="screen active">
        <div class="grid gap-4">
            <button onclick="startTest('real')" class="bg-white p-6 rounded-[2.5rem] border-b-8 border-yellow-400 shadow-sm text-left">
                <i class="fas fa-bolt text-yellow-500 text-3xl mb-3"></i>
                <div class="font-black text-lg">Real Test (35)</div>
            </button>
            <button onclick="startTest('full')" class="bg-white p-6 rounded-[2.5rem] border-b-8 border-blue-500 shadow-sm text-left">
                <i class="fas fa-graduation-cap text-blue-500 text-3xl mb-3"></i>
                <div class="font-black text-lg">To'liq Test (265)</div>
            </button>
        </div>
    </section>

    <section id="page-test" class="screen">
        <div class="bg-white p-4 rounded-3xl mb-4 flex justify-between items-center sticky top-0 shadow-sm z-50">
            <span id="timer" class="text-red-500 font-black text-sm">30:00</span>
            <span id="progress" class="bg-blue-50 text-blue-600 px-4 py-1 rounded-full font-black text-[11px]">0 / 0</span>
            <button onclick="exitTest()" class="text-slate-400 p-2"><i class="fas fa-times-circle text-xl"></i></button>
        </div>
        <div id="test-content"></div>
        <button id="next-btn" onclick="nextQ()" class="hidden w-full bg-slate-900 text-white py-5 rounded-[2rem] font-black mt-6">KEYINGISI</button>
    </section>

    <section id="page-rating" class="screen">
        <div class="flex gap-2 mb-6 bg-white p-2 rounded-2xl border">
            <button onclick="loadRat('real')" id="rat-real-btn" class="flex-1 py-3 rounded-xl text-[11px] font-black transition">REAL</button>
            <button onclick="loadRat('full')" id="rat-full-btn" class="flex-1 py-3 rounded-xl text-[11px] font-black transition">TO'LIQ</button>
        </div>
        <div id="rating-list" class="space-y-3"></div>
    </section>
</div>

<nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex h-20 shadow-2xl px-10 items-center z-[100]">
    <button onclick="showPage('home')" class="flex-1 text-slate-400 flex flex-col items-center"><i class="fas fa-home"></i><span class="text-[9px] mt-1 font-bold">ASOSIY</span></button>
    <button onclick="showPage('rating')" class="flex-1 text-slate-400 flex flex-col items-center"><i class="fas fa-crown"></i><span class="text-[9px] mt-1 font-bold">REYTING</span></button>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, setDoc, doc, query, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
        authDomain: "gen-lang-client-0228947349.firebaseapp.com",
        projectId: "gen-lang-client-0228947349",
        storageBucket: "gen-lang-client-0228947349.firebasestorage.app",
        appId: "1:253793341504:web:709752258000dab44fcfa5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const tg = window.Telegram.WebApp;

    const user = tg.initDataUnsafe?.user;
    const isGuest = !user || !user.first_name || user.first_name.toLowerCase().includes("mehmon");
    const uid = user?.id?.toString() || "guest_" + Math.random().toString(36).substr(2, 5);
    const uName = user ? `${user.first_name} ${user.last_name || ''}`.trim() : "Mehmon";

    let masterData = [], currentTestData = [], currentIdx = 0, score = 0, timer, mode = 'real', answered = false, lastChatTime = Date.now();

    async function init() {
        const cached = localStorage.getItem('quiz_cache');
        if (cached) masterData = JSON.parse(cached);
        const snap = await getDocs(query(collection(db, "oliy_matematika_testlar"), orderBy("serverTime", "asc")));
        if (!snap.empty) {
            masterData = snap.docs.map(d => d.data());
            localStorage.setItem('quiz_cache', JSON.stringify(masterData));
        }

        setDoc(doc(db, "online_users", uid), { name: uName, time: serverTimestamp() }, { merge: true });
        onSnapshot(collection(db, "online_users"), (s) => {
            let count = 0, names = [];
            s.forEach(d => {
                if(!d.data().name.toLowerCase().includes("mehmon")) {
                    count++;
                    names.push(`<span class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full border border-blue-100 text-[9px] font-bold">‚óè ${d.data().name}</span>`);
                }
            });
            document.getElementById('online-count').innerText = count;
            document.getElementById('online-list').innerHTML = names.join("");
        });

        onSnapshot(query(collection(db, "global_chat"), orderBy("time", "desc"), limit(25)), (s) => {
            let h = "";
            s.forEach((d, index) => {
                const m = d.data();
                h += `<div class="msg ${m.uid === uid ? 'my-msg' : 'other-msg'}">
                        <div class="text-[9px] font-black opacity-70 mb-1 uppercase">${m.name}</div>
                        ${m.text}
                      </div>`;
                if (index === 0 && m.uid !== uid && m.time?.toMillis() > lastChatTime) {
                    tg.showAlert(`Yangi xabar: ${m.name}\n${m.text}`);
                    lastChatTime = m.time.toMillis();
                }
            });
            document.getElementById('chat-messages').innerHTML = h;
        });
    }

    // TUZATILGAN CHIQISH FUNKSIYASI
    window.exitTest = () => {
        if(confirm("Testni yakunlab, asosiy sahifaga qaytasizmi?")) {
            clearInterval(timer);
            showPage('home');
        }
    };

    window.toggleChat = () => document.getElementById('chat-ui').classList.toggle('hidden');
    window.sendMsg = async () => {
        const inp = document.getElementById('chat-input');
        if(!inp.value.trim()) return;
        await addDoc(collection(db, "global_chat"), { uid, name: uName, text: inp.value, time: serverTimestamp() });
        inp.value = "";
    };

    window.showPage = (p) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('page-' + p).classList.add('active');
        if(p === 'rating') loadRat('real');
    };

    window.startTest = (m) => {
        mode = m; currentIdx = 0; score = 0;
        showPage('test');
        if(mode === 'real') {
            currentTestData = [...masterData].sort(() => Math.random() - 0.5).slice(0, 35);
            startTimer(30 * 60);
        } else {
            currentTestData = [...masterData];
            document.getElementById('timer').innerText = "LIMITSIZ";
        }
        renderQ();
    };

    function renderQ() {
        if(currentIdx >= currentTestData.length) return endTest();
        document.getElementById('progress').innerText = `${currentIdx + 1} / ${currentTestData.length}`;
        document.getElementById('next-btn').classList.add('hidden');
        answered = false;
        const q = currentTestData[currentIdx];
        let opts = q.options.map((t, i) => ({ t, isC: i === q.correctIndex }));
        opts.sort(() => Math.random() - 0.5);
        document.getElementById('test-content').innerHTML = `
            <div class="bg-white p-7 rounded-[2.5rem] shadow-sm border border-slate-100">
                <div class="mb-6 font-bold text-slate-800 text-lg">${q.question}</div>
                <div class="space-y-3">${opts.map(o => `<button onclick="check(this, ${o.isC})" class="opt-btn" data-c="${o.isC}">${o.t}</button>`).join("")}</div>
            </div>`;
    }

    window.check = (btn, isC) => {
        if(answered) return;
        answered = true;
        if(mode === 'full') {
            if(isC) { btn.classList.add('correct'); score++; }
            else { 
                btn.classList.add('wrong');
                document.querySelectorAll('.opt-btn').forEach(b => { if(b.dataset.c === 'true') b.classList.add('correct'); });
            }
        } else {
            btn.classList.add('selected-real');
            if(isC) score++;
        }
        document.getElementById('next-btn').classList.remove('hidden');
    };

    window.nextQ = () => { currentIdx++; renderQ(); };

    window.endTest = async () => {
        clearInterval(timer);
        if(!isGuest) {
            const col = mode === 'real' ? "ratings_real" : "ratings_full";
            await setDoc(doc(db, col, uid), { name: uName, score, total: currentTestData.length, date: Date.now() });
        }
        const pass = score >= 42;
        document.getElementById('test-content').innerHTML = `
            <div class="bg-white p-12 rounded-[3.5rem] shadow-2xl text-center border-t-[12px] ${pass ? 'border-green-500':'border-red-500'}">
                <div class="text-5xl mb-2 font-black">${score}</div>
                <div class="text-lg font-black mb-8">${pass ? "O'TDINGIZ" : "YIQILDINGIZ"}</div>
                <button onclick="showPage('home')" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black shadow-lg">ASOSIY</button>
            </div>`;
    };

    window.loadRat = async (m) => {
        const col = m === 'real' ? "ratings_real" : "ratings_full";
        document.getElementById('rat-real-btn').className = m === 'real' ? "flex-1 py-3 rounded-xl text-[11px] font-black bg-blue-600 text-white" : "flex-1 py-3 rounded-xl text-[11px] font-black text-slate-400";
        document.getElementById('rat-full-btn').className = m === 'full' ? "flex-1 py-3 rounded-xl text-[11px] font-black bg-blue-600 text-white" : "flex-1 py-3 rounded-xl text-[11px] font-black text-slate-400";
        const snap = await getDocs(query(collection(db, col), orderBy("score", "desc"), limit(25)));
        let h = "";
        snap.forEach((d, i) => {
            const data = d.data();
            const index = isNaN(i + 1) ? "" : `#${i + 1}`; 
            h += `<div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-slate-50 shadow-sm">
                    <div class="text-sm font-bold text-slate-700">${index} ${data.name}</div>
                    <div class="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg font-black text-xs">${data.score} / ${data.total}</div>
                </div>`;
        });
        document.getElementById('rating-list').innerHTML = h || "<p class='text-center py-20 text-slate-300'>BO'SH</p>";
    };

    function startTimer(s) {
        clearInterval(timer);
        timer = setInterval(() => {
            let m = Math.floor(s/60), sec = s%60;
            document.getElementById('timer').innerText = `${m}:${sec<10?'0'+sec:sec}`;
            if(--s<0) endTest();
        }, 1000);
    }
    init();
</script>
</body>
</html>
