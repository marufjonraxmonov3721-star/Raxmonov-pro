<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>Matritsalar - REAL TEST</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --primary: #38bdf8; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --success: #10b981; --danger: #ef4444; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .opt { background: #334155; color: white; text-align: left; }
        .opt.correct { background: var(--success) !important; }
        .opt.wrong { background: var(--danger) !important; }
        .start-btn { background: var(--primary); color: #000; }
        .hidden { display: none; }
        #timer { font-size: 24px; text-align: center; color: #fbbf24; margin-bottom: 10px; font-weight: bold; }
        .header { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 15px; color: var(--primary); }
    </style>
</head>
<body>

<div id="home-screen" class="card">
    <h2 style="text-align:center;">Matritsalar: Real Test</h2>
    <div id="status" style="text-align:center; font-size:12px; margin-bottom:10px;">Baza tekshirilmoqda...</div>
    <button class="btn start-btn" onclick="startExam()">TESTNI BOSHLASH</button>
</div>

<div id="test-screen" class="card hidden">
    <div id="timer">30:00</div>
    <div class="header">
        <span id="q-num">Savol: 1/35</span>
        <span id="q-score">Ball: 0</span>
    </div>
    <h3 id="question-text">Yuklanmoqda...</h3>
    <div id="options-area"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
        authDomain: "gen-lang-client-0228947349.firebaseapp.com",
        databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
        projectId: "gen-lang-client-0228947349",
        storageBucket: "gen-lang-client-0228947349.firebasestorage.app",
        messagingSenderId: "253793341504",
        appId: "1:253793341504:web:709752258000dab44fcfa5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;

    let pool = [], currentQs = [], step = 0, score = 0, timer;

    // 1. Bazadan savollarni o'qish
    onValue(ref(db, 'questions_pool'), (snap) => {
        const data = snap.val();
        if (data) {
            pool = Array.isArray(data) ? data : Object.values(data);
            document.getElementById('status').innerHTML = `<b style="color:#10b981">Tayyor: ${pool.length} ta savol</b>`;
        } else {
            document.getElementById('status').innerHTML = `<b style="color:#ef4444">Baza bo'sh yoki xato!</b>`;
        }
    });

    // 2. Testni boshlash
    window.startExam = () => {
        if (pool.length < 1) return alert("Savollar hali kelmadi!");
        
        tg.expand();
        currentQs = [...pool].sort(() => 0.5 - Math.random()).slice(0, 35);
        step = 0; score = 0;
        
        document.getElementById('home-screen').classList.add('hidden');
        document.getElementById('test-screen').classList.remove('hidden');
        
        runTimer(30 * 60);
        showQuestion();
    };

    // 3. Savolni chiqarish
    function showQuestion() {
        const q = currentQs[step];
        document.getElementById('q-num').innerText = `Savol: ${step + 1}/${currentQs.length}`;
        document.getElementById('q-score').innerText = `Ball: ${score * 2}`;
        document.getElementById('question-text').innerText = q.q;
        
        const area = document.getElementById('options-area');
        area.innerHTML = "";
        
        const opts = Array.isArray(q.a) ? q.a : [q.a];
        opts.forEach((text, i) => {
            const b = document.createElement('button');
            b.className = 'btn opt';
            b.innerText = text;
            b.onclick = () => check(i, q.c, b);
            area.appendChild(b);
        });
    }

    // 4. Javobni tekshirish
    function check(idx, correct, btn) {
        const all = document.querySelectorAll('.opt');
        all.forEach(b => b.disabled = true);
        
        if (idx === correct) {
            btn.classList.add('correct');
            score++;
        } else {
            btn.classList.add('wrong');
            all[correct].classList.add('correct');
        }

        setTimeout(() => {
            step++;
            if (step < currentQs.length) showQuestion();
            else finish();
        }, 1000);
    }

    // 5. Taymer
    function runTimer(sec) {
        timer = setInterval(() => {
            let m = Math.floor(sec / 60), s = sec % 60;
            document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if (--sec < 0) { clearInterval(timer); finish(); }
        }, 1000);
    }

    // 6. Yakunlash va Rekord
    async function finish() {
        clearInterval(timer);
        const final = score * 2;
        const uid = tg.initDataUnsafe?.user?.id || "Mehmon";
        const name = tg.initDataUnsafe?.user?.first_name || "Noma'lum";

        if (uid !== "Mehmon") {
            const userRef = ref(db, 'best_scores/' + uid);
            const old = await get(userRef);
            if (!old.exists() || old.val().score < final) {
                await set(userRef, { name, score: final });
            }
        }

        document.getElementById('test-screen').innerHTML = `
            <div style="text-align:center;">
                <h2>Test Tugadi!</h2>
                <h1 style="color:var(--primary);">${final} Ball</h1>
                <p>${score} ta to'g'ri javob</p>
                <button class="btn start-btn" onclick="location.reload()">QAYTISH</button>
            </div>`;
    }
</script>
</body>
</html>
