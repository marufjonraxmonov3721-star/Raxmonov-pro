<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full Leaderboard Quiz</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f8fafc; --gold: #f59e0b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); box-sizing: border-box; }
        .hidden { display: none; }
        .btn { background: var(--accent); border: none; padding: 15px; border-radius: 12px; color: #0f172a; font-weight: bold; cursor: pointer; width: 100%; margin-top: 15px; font-size: 16px; }
        
        /* Reyting stili - Toza va # belgisiz */
        .leaderboard { margin-top: 15px; max-height: 400px; overflow-y: auto; padding-right: 5px; }
        .user-card { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #334155; align-items: center; margin-bottom: 5px; background: rgba(255,255,255,0.03); border-radius: 10px; }
        .rank { width: 30px; font-weight: bold; color: #94a3b8; font-size: 14px; }
        .avatar { width: 35px; height: 35px; border-radius: 50%; margin-right: 12px; border: 1px solid var(--accent); }
        .user-name { flex-grow: 1; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-score { font-weight: bold; color: var(--accent); margin-left: 10px; }
        
        /* Scrollbar dizayni */
        .leaderboard::-webkit-scrollbar { width: 4px; }
        .leaderboard::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        h2, h3 { text-align: center; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container" id="setup-screen">
    <h2 id="welcome-user">Salom!</h2>
    <button class="btn" onclick="startQuiz()">O'yinni boshlash</button>
</div>

<div class="container hidden" id="quiz-screen">
    <h3 id="question-text">Savol...</h3>
    <div id="options-container"></div>
</div>

<div class="container hidden" id="result-screen">
    <h3>Natijangiz: <span id="final-score">0</span> ball</h3>
    <hr style="border: 0.5px solid #334155;">
    <h3>üèÜ BARCHA ISHTIROKCHILAR</h3>
    <div class="leaderboard" id="leaderboard">
        <p style="text-align:center">Yuklanmoqda...</p>
    </div>
    <button class="btn" onclick="location.reload()">Qayta o'ynash</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, update, onValue, query, orderByChild, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
        authDomain: "gen-lang-client-0228947349.firebaseapp.com",
        databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
        projectId: "gen-lang-client-0228947349",
        storageBucket: "gen-lang-client-0228947349.firebasestorage.app",
        messagingSenderId: "253793341504",
        appId: "1:253793341504:web:709752258000dab44fcfa5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    const userData = tg.initDataUnsafe?.user || { id: "test", first_name: "Mehmon" };

    const questions = [
        { q: "O'zbekiston poytaxti?", a: ["Toshkent", "Buxoro"], c: 0 },
        { q: "Dunyodagi eng katta okean?", a: ["Atlantika", "Tinch"], c: 1 },
        { q: "HTML nima?", a: ["Dasturlash tili", "Belgilash tili"], c: 1 },
        { q: "8x8 necha?", a: ["64", "56"], c: 0 },
        { q: "IT so'zining kengaytmasi?", a: ["Info Tech", "Internet Tech"], c: 0 }
        // Savollarni ko'paytirishingiz mumkin...
    ];

    let currentIdx = 0, score = 0;

    window.startQuiz = () => {
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        showQuestion();
    };

    function showQuestion() {
        const q = questions[currentIdx];
        document.getElementById('question-text').innerText = q.q;
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        q.a.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.style.background = "#334155";
            btn.style.color = "white";
            btn.innerText = opt;
            btn.onclick = () => {
                if (i === q.c) score += 10;
                currentIdx++;
                currentIdx < questions.length ? showQuestion() : finishQuiz();
            };
            container.appendChild(btn);
        });
    }

    async function finishQuiz() {
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('final-score').innerText = score;

        const userRef = ref(db, 'leaderboard/' + userData.id);
        const snap = await get(userRef);
        if (!snap.exists() || score > snap.val().score) {
            await update(userRef, {
                username: userData.first_name,
                score: score,
                photo: userData.photo_url || ""
            });
        }
        loadLeaderboard();
    }

    function loadLeaderboard() {
        // limitToLast OLIB TASHLANDI - HAMMA CHIQADI
        const topRef = query(ref(db, 'leaderboard'), orderByChild('score'));
        
        onValue(topRef, (snap) => {
            const board = document.getElementById('leaderboard');
            board.innerHTML = '';
            let list = [];
            
            snap.forEach(child => {
                list.push(child.val());
            });

            // Ballar bo'yicha kamayish tartibida saralash
            list.sort((a, b) => b.score - a.score);

            list.forEach((u, i) => {
                board.innerHTML += `
                    <div class="user-card">
                        <span class="rank">${i + 1}</span> 
                        <img src="${u.photo || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" class="avatar">
                        <span class="user-name">${u.username}</span>
                        <span class="user-score">${u.score} ball</span>
                    </div>`;
            });
        });
    }
</script>
</body>
</html>
