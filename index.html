<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --bg: #f0f2f5; --card: #ffffff; --text: #1c1e21;
            --p: #0088cc; --gradient: linear-gradient(135deg, #0088cc 0%, #005588 100%);
        }
        body.dark { --bg: #18191a; --card: #242526; --text: #e4e6eb; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; transition: 0.3s; overflow-x: hidden; }

        .header-title { text-align: center; padding: 20px 0; margin: 0; font-size: 24px; font-weight: bold; text-transform: capitalize; }
        .page { display: none; padding: 15px; max-width: 500px; margin: auto; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 15px; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 16px; margin-bottom: 10px; transition: 0.2s; }
        .btn-p { background: var(--gradient); color: white; }
        .btn-next { background: #10b981; color: white; display: none; margin-top: 15px; }

        .option { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #ddd; border-radius: 12px; background: none; color: var(--text); text-align: center; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; min-height: 55px; }
        .option img { max-height: 23px; max-width: 100%; object-fit: contain; }
        
        .correct { background: #d1fae5 !important; border-color: #10b981 !important; color: #064e3b !important; font-weight: bold; }
        .wrong { background: #fee2e2 !important; border-color: #ef4444 !important; color: #7f1d1d !important; font-weight: bold; }

        .nav-bar { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; border-top: 1px solid rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; font-size: 12px; color: #888; cursor: pointer; }
        .nav-item.active { color: var(--p); font-weight: bold; }
        .nav-item i { font-size: 25px; display: block; margin-bottom: 4px; }

        #img-modal { display: none; position: fixed; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        #img-modal img { max-width: 95%; max-height: 95%; }

        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; background: var(--p); color: white; margin-top: 5px; display: inline-block; }
        #timer-box { font-weight: bold; color: #d93025; font-size: 18px; }

        .rank-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .rank-score { font-weight: bold; color: #10b981; }

        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--p); }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div id="img-modal" onclick="this.style.display='none'"><img id="modal-img" src=""></div>
    <h2 id="main-title" class="header-title">Asosiy</h2>

    <div id="p-home" class="page active">
        <div class="card" style="background: var(--gradient); color: white;">
            <h3>O'quv kursi</h3>
            <p>Vaqt cheksiz, xatolar ustida ishlash mumkin.</p>
            <button class="btn" style="background: white; color: var(--p);" onclick="startQuiz('all')">O'RGANISH</button>
        </div>
        <div class="card" style="border: 2px solid var(--p);">
            <h3>Real Test</h3>
            <p>35 ta savol | 30 daqiqa | Guruhga natija yuboriladi.</p>
            <button class="btn btn-p" onclick="startQuiz('real')">TESTNI BOSHLASH</button>
        </div>
    </div>

    <div id="p-quiz" class="page">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <span id="timer-box">--:--</span>
                <span id="progress" style="font-weight: bold;">0/0</span>
            </div>
            <div id="q-text" style="font-size: 18px; font-weight: bold; margin-bottom: 15px;"></div>
            <div id="q-img-cont" style="display:none; text-align:center; margin-bottom:15px;"><img id="q-image" style="max-width:100%; max-height:200px; cursor:zoom-in;" onclick="zoomImg(this.src)"></div>
            <div id="options"></div>
            <button id="next-btn" class="btn btn-next">KEYINGI SAVOL <i class="fas fa-arrow-right"></i></button>
        </div>
    </div>

    <div id="p-res" class="page">
        <div class="card" style="text-align: center;">
            <h2 id="res-status">--</h2>
            <div id="res-details" style="font-size: 18px; margin: 20px 0;"></div>
            <button class="btn btn-p" onclick="location.reload()">ASOSIY MENYU</button>
        </div>
    </div>

    <div id="p-rank" class="page">
        <div class="card" id="rank-list"><p style="text-align:center">Yuklanmoqda...</p></div>
    </div>

    <div id="p-settings" class="page">
        <div class="card">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="background: var(--p); color:white; width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px;"><i class="fas fa-user"></i></div>
                <div>
                    <b id="u-name">...</b><br>
                    <span class="badge" id="u-level">Daraja: Yuklanmoqda...</span>
                </div>
            </div>
            <hr style="margin:20px 0; opacity:0.1;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>Tungi rejim</span>
                <label class="switch">
                    <input type="checkbox" id="dark-toggle" onchange="toggleDark()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="nav('p-home', this, 'Asosiy')"><i class="fas fa-home"></i>Asosiy</div>
        <div class="nav-item" onclick="nav('p-rank', this, 'Reyting'); loadRank()"><i class="fas fa-chart-line"></i>Reyting</div>
        <div class="nav-item" onclick="nav('p-settings', this, 'Sozlamalar')"><i class="fas fa-cog"></i>Sozlamalar</div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, doc, getDoc, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyCavyC9nUUT4Rk2Xh2wq2rKhIGZwSr97uM", projectId: "meningquizilovam", appId: "1:107483720751:web:505d527fbccbbf4ce26ada" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    const BOT_TOKEN = "8578977118:AAF7NUUOg2kVYzoO-pzZsiWH_L-8vvU8GUk";
    const GROUP_ID = "-1003218015225";

    let allQs = [], currentQs = [], score = 0, curIdx = 0, mode = "", timer;
    const uid = tg.initDataUnsafe?.user?.id?.toString() || null;
    const uname = tg.initDataUnsafe?.user?.first_name || "Mehmon";

    window.nav = (id, el, title) => {
        document.getElementById('main-title').innerText = title;
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(el) el.classList.add('active');
        if(id === 'p-settings') updateLevelDisplay();
    };

    window.toggleDark = () => {
        const dark = document.getElementById('dark-toggle').checked;
        document.body.classList.toggle('dark', dark);
        localStorage.setItem('dark', dark);
    };
    if(localStorage.getItem('dark') === 'true') {
        document.getElementById('dark-toggle').checked = true;
        document.body.classList.add('dark');
    }

    async function updateLevelDisplay() {
        document.getElementById('u-name').innerText = uname;
        if (!uid) { document.getElementById('u-level').innerText = "Daraja: Kirilmagan"; return; }
        const snap = await getDoc(doc(db, "reyting", uid));
        let s = snap.exists() ? snap.data().score : 0;
        let lv = s >= 66 ? "A'lo üèÜ" : s >= 51 ? "Yaxshi ‚úÖ" : s >= 31 ? "Qoniqarli ‚ö†Ô∏è" : "Yomon üõë";
        document.getElementById('u-level').innerText = "Daraja: " + lv;
    }

    window.zoomImg = (s) => { document.getElementById('modal-img').src = s; document.getElementById('img-modal').style.display = 'flex'; };

    async function loadData() {
        const q = query(collection(db, "savollar"), orderBy("createdAt", "asc"));
        const snap = await getDocs(q);
        allQs = snap.docs.map(d => d.data());
    }

    window.startQuiz = async (m) => {
        if(allQs.length === 0) await loadData();
        mode = m; curIdx = 0; score = 0;
        clearInterval(timer);
        if(mode === 'real') {
            currentQs = [...allQs].sort(() => 0.5 - Math.random()).slice(0, 35);
            startTimer(30 * 60);
        } else {
            currentQs = [...allQs];
            document.getElementById('timer-box').innerText = "Mashq";
        }
        nav('p-quiz', null, 'Test'); renderQ();
    };

    function startTimer(s) {
        timer = setInterval(() => {
            let m = Math.floor(s/60), sc = s%60;
            document.getElementById('timer-box').innerText = `${m}:${sc<10?'0':''}${sc}`;
            if(--s < 0) finish();
        }, 1000);
    }

    function renderQ() {
        if(curIdx >= currentQs.length) return finish();
        const q = currentQs[curIdx];
        document.getElementById('progress').innerText = `${curIdx+1}/${currentQs.length}`;
        document.getElementById('next-btn').style.display = 'none';
        const qTxt = document.getElementById('q-text');
        const qImgC = document.getElementById('q-img-cont');
        if(q.text.startsWith('data:image')) {
            qTxt.innerText = "Savol:"; document.getElementById('q-image').src = q.text; qImgC.style.display = 'block';
        } else { qTxt.innerText = q.text; qImgC.style.display = 'none'; }

        const box = document.getElementById('options');
        box.innerHTML = '';
        const correct = q.variants[0];
        let opts = [...q.variants].sort(() => 0.5 - Math.random());
        opts.forEach(opt => {
            const b = document.createElement('button');
            b.className = 'option';
            b.innerHTML = opt.startsWith('data:image') ? `<img src="${opt}">` : opt;
            b.onclick = () => {
                const btns = box.querySelectorAll('.option');
                if(mode === 'all') {
                    btns.forEach(x => x.disabled = true);
                    if(opt === correct) { b.classList.add('correct'); score++; }
                    else { b.classList.add('wrong'); btns.forEach(x => { if(x.innerHTML.includes(correct)) x.classList.add('correct'); }); }
                    document.getElementById('next-btn').style.display = 'block';
                } else { if(opt === correct) score++; curIdx++; renderQ(); }
            };
            box.appendChild(b);
        });
    }

    document.getElementById('next-btn').onclick = () => { curIdx++; renderQ(); };

    async function finish() {
        clearInterval(timer);
        nav('p-res', null, 'Natija');
        const ball = score * 2;
        let grade = "", medal = "", msg = "";

        if(ball >= 66) { grade = "A'lo üèÜ"; medal = "ü•á"; msg = "Siz haqiqiy professorsiz!"; }
        else if(ball >= 51) { grade = "Yaxshi ‚úÖ"; medal = "ü•à"; msg = "Ajoyib natija, ozgina qoldi!"; }
        else if(ball >= 31) { grade = "Qoniqarli ‚ö†Ô∏è"; medal = "ü•â"; msg = "Yana ko'proq o'qing!"; }
        else { grade = "Yomon üõë"; medal = "üéñ"; msg = "Xafa bo'lmang, qaytadan urinib ko'ring!"; }

        document.getElementById('res-status').innerText = grade;
        document.getElementById('res-details').innerHTML = `To'g'ri: ${score}/${currentQs.length}<br>Ball: ${ball}`;
        
        // Konfetti effekti
        if(ball >= 31) {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }

        if(mode === 'real' && uid) {
            const ref = doc(db, "reyting", uid);
            const old = await getDoc(ref);
            if(!old.exists() || ball > old.data().score) await setDoc(ref, { name: uname, score: ball, date: serverTimestamp() });

            // Guruhga chiroyli xabar
            const text = `‚ú® *YANGI FOVIY NATIJA* ‚ú®\n\n${medal} *Talaba:* ${uname}\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nüéØ *Natija:* ${score} / ${currentQs.length} ta\nüíé *To'plangan ball:* ${ball} ball\nüåü *Holati:* ${grade}\n\nüí¨ *Xulosa:* _${msg}_\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nüöÄ *O'z ustingizda ishlashda davom eting!*`;
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${GROUP_ID}&text=${encodeURIComponent(text)}&parse_mode=Markdown`);
        }
    }

    window.loadRank = async () => {
        const list = document.getElementById('rank-list');
        list.innerHTML = '<p style="text-align:center">Yuklanmoqda...</p>';
        const q = query(collection(db, "reyting"), orderBy("score", "desc"), limit(20));
        const snap = await getDocs(q);
        list.innerHTML = '';
        let i = 1;
        snap.forEach(d => {
            list.innerHTML += `<div class="rank-item"><span>${i++}. ${d.data().name}</span><span class="rank-score">${d.data().score}</span></div>`;
        });
    };

    loadData();
</script>
</body>
</html>
