<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Global Leaderboard Quiz</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f8fafc; --gold: #f59e0b; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 450px; background: var(--card); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); box-sizing: border-box; }
        .hidden { display: none; }
        .btn { background: var(--accent); border: none; padding: 15px; border-radius: 12px; color: #0f172a; font-weight: bold; cursor: pointer; width: 100%; margin-top: 15px; font-size: 16px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .option-btn { background: #334155; color: white; text-align: left; margin-bottom: 12px; display: block; width: 100%; padding: 15px; border: 1px solid #475569; border-radius: 12px; font-size: 15px; }
        .option-btn:hover { background: #475569; }
        
        /* Reyting stili */
        .leaderboard { margin-top: 15px; }
        .user-card { display: flex; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid #334155; align-items: center; background: rgba(255,255,255,0.02); margin-bottom: 5px; border-radius: 8px; }
        .rank { width: 35px; font-weight: bold; color: #94a3b8; }
        .rank-1 { color: var(--gold); }
        .user-name { flex-grow: 1; font-weight: 500; }
        .user-score { font-weight: bold; color: var(--accent); }
        
        h2, h3 { text-align: center; margin-bottom: 20px; color: var(--accent); }
        .quiz-info { text-align: center; font-size: 14px; color: #94a3b8; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container" id="setup-screen">
    <h2 id="welcome-user">Xush kelibsiz!</h2>
    <p class="quiz-info">10 ta savolga javob bering va global reytingda birinchi bo'ling!</p>
    <button class="btn" onclick="startQuiz()">O'yinni boshlash</button>
</div>

<div class="container hidden" id="quiz-screen">
    <div id="progress" style="text-align: right; font-size: 12px; color: #38bdf8; margin-bottom: 5px;"></div>
    <h3 id="question-text">Savol yuklanmoqda...</h3>
    <div id="options-container"></div>
</div>

<div class="container hidden" id="result-screen">
    <h3>Natijangiz: <span id="final-score" style="color:white">0</span> ball</h3>
    <p style="text-align:center; font-size: 13px;">Reyting avtomatik yangilanadi</p>
    <div class="leaderboard" id="leaderboard">
        <p style="text-align:center">Reyting yuklanmoqda...</p>
    </div>
    <button class="btn" onclick="location.reload()">Qayta urinish</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, update, onValue, query, orderByChild, limitToLast, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
        authDomain: "gen-lang-client-0228947349.firebaseapp.com",
        databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
        projectId: "gen-lang-client-0228947349",
        storageBucket: "gen-lang-client-0228947349.firebasestorage.app",
        messagingSenderId: "253793341504",
        appId: "1:253793341504:web:709752258000dab44fcfa5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;

    // Telegram User Data
    const userData = tg.initDataUnsafe?.user || { id: "guest_" + Math.floor(Math.random()*1000), first_name: "Mehmon" };
    document.getElementById('welcome-user').innerText = `Salom, ${userData.first_name}!`;
    tg.expand();

    const questions = [
        { q: "O'zbekiston poytaxti qaysi?", a: ["Toshkent", "Samarqand", "Buxoro"], c: 0 },
        { q: "HTML nima?", a: ["Dasturlash tili", "Belgilash tili", "Baza turi"], c: 1 },
        { q: "Telegram asoschisi kim?", a: ["Mark Zuckerberg", "Pavel Durov", "Elon Musk"], c: 1 },
        { q: "8 x 8 necha?", a: ["64", "56", "72"], c: 0 },
        { q: "Qaysi sayyora 'Qizil sayyora' deyiladi?", a: ["Venera", "Mars", "Yupiter"], c: 1 },
        { q: "Eng uzun daryo?", a: ["Nil", "Amazonka", "Amudaryo"], c: 0 },
        { q: "Dunyoning eng baland cho'qqisi?", a: ["K2", "Everest", "Monblan"], c: 1 },
        { q: "JavaScript qachon yaratilgan?", a: ["1995", "2005", "1985"], c: 0 },
        { q: "O'zbekiston bayrog'ida nechta yulduz bor?", a: ["10", "12", "15"], c: 1 },
        { q: "IT so'zining kengaytmasi nima?", a: ["Information Tech", "Internal Team", "Internet Tech"], c: 0 }
    ];

    let currentIdx = 0, score = 0;

    window.startQuiz = () => {
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        showQuestion();
    };

    function showQuestion() {
        const q = questions[currentIdx];
        document.getElementById('progress').innerText = `${currentIdx + 1} / ${questions.length}`;
        document.getElementById('question-text').innerText = q.q;
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        
        q.a.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => {
                if (i === q.c) score += 10;
                currentIdx++;
                currentIdx < questions.length ? showQuestion() : finishQuiz();
            };
            container.appendChild(btn);
        });
    }

    async function finishQuiz() {
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('final-score').innerText = score;

        // Bazaga saqlash
        const userRef = ref(db, 'leaderboard/' + userData.id);
        const snapshot = await get(userRef);
        const existingData = snapshot.val();

        // Faqat rekord yangilansa bazaga yozamiz
        if (!existingData || score > existingData.score) {
            await update(userRef, {
                username: userData.first_name,
                score: score,
                timestamp: Date.now()
            });
        }
        
        loadLeaderboard();
    }

    function loadLeaderboard() {
        // Bal bo'yicha eng yuqori 10 tani olish
        const topRef = query(ref(db, 'leaderboard'), orderByChild('score'), limitToLast(10));
        
        onValue(topRef, (snap) => {
            const board = document.getElementById('leaderboard');
            board.innerHTML = '';
            let list = [];
            
            snap.forEach(child => {
                list.push(child.val());
            });

            // Firebase o'sish tartibida beradi, biz teskari (kamayish) qilamiz
            list.sort((a, b) => b.score - a.score);

            if (list.length === 0) {
                board.innerHTML = "<p style='text-align:center'>Hozircha hech kim yo'q</p>";
                return;
            }

            list.forEach((u, i) => {
                const isFirst = i === 0 ? 'rank-1' : '';
                board.innerHTML += `
                    <div class="user-card">
                        <span class="rank ${isFirst}">#${i+1}</span>
                        <span class="user-name">${u.username}</span>
                        <span class="user-score">${u.score} ball</span>
                    </div>`;
            });
        });
    }
</script>

</body>
</html>
