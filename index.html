<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yo'nalishga kirish</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --bg: #f3f4f6; --card: #ffffff; --text: #1f2937;
            --p: #4f46e5; --gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        body.dark { --bg: #111827; --card: #1f2937; --text: #f9fafb; --shadow: 0 4px 20px rgba(0,0,0,0.4); }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; transition: 0.3s; overflow-x: hidden; }
        
        .page { display: none; padding: 20px; max-width: 500px; margin: auto; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card); padding: 22px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 18px; }
        .btn-main { width: 100%; padding: 16px; background: var(--gradient); color: white; border: none; border-radius: 14px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; }
        .btn-next { display: none; background: #10b981; margin-top: 20px; border: none; border-radius: 14px; padding: 16px; color: white; width: 100%; font-weight: bold; cursor: pointer; }

        .option { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #e5e7eb; border-radius: 12px; background: none; color: var(--text); text-align: left; font-size: 16px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; }
        .option img { max-height: 22px; max-width: 100%; object-fit: contain; }
        
        .correct { background: #d1fae5 !important; border-color: #10b981 !important; color: #064e3b !important; font-weight: bold; }
        .wrong { background: #fee2e2 !important; border-color: #ef4444 !important; color: #7f1d1d !important; font-weight: bold; }
        
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; padding: 12px 0; border-top: 1px solid rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { cursor: pointer; text-align: center; flex: 1; font-size: 11px; color: #9ca3af; }
        .nav-item.active { color: var(--p); font-weight: bold; }
        .nav-item i { font-size: 22px; display: block; margin-bottom: 4px; }

        .switch { position: relative; width: 44px; height: 24px; display: inline-block; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #d1d5db; border-radius: 24px; transition: 0.4s; }
        .slider:before { content: ""; position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.4s; }
        input:checked + .slider { background: var(--p); }
        input:checked + .slider:before { transform: translateX(20px); }

        .cert-img { width: 100%; border-radius: 10px; margin-top: 15px; border: 2px solid var(--p); }
        .q-img { width: 100%; max-height: 250px; object-fit: contain; margin-bottom: 15px; border-radius: 10px; display: none; }

        /* BLOK EKRANI */
        #ban-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111827; z-index: 9999; color: white; flex-direction: column;
            align-items: center; justify-content: center; text-align: center; padding: 20px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div id="ban-overlay">
        <i class="fas fa-user-slash" style="font-size: 70px; color: #ef4444; margin-bottom: 20px;"></i>
        <h1 style="margin: 0;">Siz bloklangansiz!</h1>
        <p style="color: #9ca3af; margin-top: 15px;">Ilovadan foydalanish huquqingiz admin tomonidan cheklangan.</p>
        <button class="btn-main" onclick="tg.close()" style="width: auto; padding: 12px 30px; margin-top: 20px;">YOPISH</button>
    </div>

    <div id="main-app">
        <div id="page-home" class="page active">
            <h2>Yo'nalishga kirish</h2>
            <div class="card" style="background: var(--gradient); color: white;">
                <h3>Imtihon Rejimi</h3>
                <p>35 ta savol. 30 daqiqa. 80% ball uchun sertifikat!</p>
                <button class="btn-main" style="background: white; color: var(--p);" onclick="startMode('real')">BOSHLASH</button>
            </div>
            <div class="card">
                <h3>O'quv kursi</h3>
                <p>245 ta savol (Tartib bilan). Tahlil va "Keyingi" tugmasi.</p>
                <button class="btn-main" onclick="startMode('all')">O'RGANISH</button>
            </div>
        </div>

        <div id="quiz-screen" class="page">
            <div class="card">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <span id="timer-label" style="font-weight: bold;">--:--</span>
                    <span id="counter-label" style="font-weight: bold;">0/0</span>
                </div>
                <div id="q-text" style="font-size: 18px; font-weight: bold; margin-bottom: 10px;"></div>
                <img id="q-image" class="q-img">
                <div id="options-box"></div>
                <button id="btn-next-step" class="btn-next" onclick="next()">KEYINGI SAVOL <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <div id="page-result" class="page">
            <div class="card" style="text-align: center;">
                <h2 id="res-status">Natija</h2>
                <div id="res-text" style="font-size: 20px; margin: 20px 0; line-height: 1.8;"></div>
                <div id="cert-area" style="display: none; margin-bottom: 15px;">
                    <img id="cert-display" class="cert-img">
                    <button class="btn-main" style="background: #10b981;" onclick="downloadCert()">SERTIFIKATNI SAQLASH</button>
                </div>
                <button class="btn-main" onclick="showReview()">XATOLAR TAHLILI</button>
                <button class="btn-main" style="background: #6b7280;" onclick="location.reload()">ASOSIY MENYU</button>
            </div>
        </div>

        <div id="page-rank" class="page">
            <h2>Reyting</h2>
            <div class="card" id="rank-container">Yuklanmoqda...</div>
        </div>

        <div id="page-settings" class="page">
            <h2>Sozlamalar</h2>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <span>Tungi rejim</span>
                    <label class="switch">
                        <input type="checkbox" id="theme-toggle" onchange="toggleDarkMode()">
                        <span class="slider"></span>
                    </label>
                </div>
                <hr style="opacity: 0.1; margin: 15px 0;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Foydalanuvchi:</span>
                    <b id="tg-name">...</b>
                </div>
            </div>
        </div>

        <div id="page-review" class="page">
            <h2>Xatolar</h2>
            <div id="review-list" class="card"></div>
            <button class="btn-main" onclick="nav('page-home')">QAYTISH</button>
        </div>

        <div class="nav-bar">
            <div class="nav-item active" onclick="nav('page-home', this)"><i class="fas fa-home"></i>Asosiy</div>
            <div class="nav-item" onclick="nav('page-rank', this); loadRankings();"><i class="fas fa-trophy"></i>Reyting</div>
            <div class="nav-item" onclick="nav('page-settings', this)"><i class="fas fa-cog"></i>Sozlamalar</div>
        </div>
    </div>

    <canvas id="cert-canvas" width="800" height="560" style="display:none;"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, setDoc, doc, updateDoc, onSnapshot, getDoc, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCavyC9nUUT4Rk2Xh2wq2rKhIGZwSr97uM",
        projectId: "meningquizilovam",
        appId: "1:107483720751:web:505d527fbccbbf4ce26ada"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    const BOT_TOKEN = "8578977118:AAF7NUUOg2kVYzoO-pzZsiWH_L-8vvU8GUk";
    const GROUP_ID = "-1003218015225";

    let allQs = [], currentQs = [], userAnswers = [];
    let curIdx = 0, timerInt = null, mode = "", isFinished = false; 
    
    const userName = tg.initDataUnsafe?.user?.first_name || "Foydalanuvchi";
    const userId = (tg.initDataUnsafe?.user?.id || "guest").toString();
    document.getElementById('tg-name').innerText = userName;

    // --- ðŸ›¡ CHEAT DETECTOR & AUTO BAN ---
    document.addEventListener("visibilitychange", async () => {
        if (document.visibilityState === 'hidden' && mode === 'real' && !isFinished) {
            const userRef = doc(db, "reyting", userId);
            const banRef = doc(db, "banned_users", userId);
            try {
                const userSnap = await getDoc(userRef);
                let currentCheats = 0;
                if(userSnap.exists()) currentCheats = userSnap.data().cheats || 0;
                await updateDoc(userRef, { cheats: currentCheats + 1 });
                
                // Avtomatik bloklash
                await setDoc(banRef, {
                    reason: "Imtihon paytida ekrandan chiqish",
                    bannedAt: serverTimestamp(),
                    userName: userName
                });

                tg.showPopup({
                    title: 'Ogohlantirish!',
                    message: 'Imtihon paytida ekrandan chiqish taqiqlangan! Siz bloklandingiz.',
                    buttons: [{type: 'ok', text: 'Tushundim'}]
                }, () => {
                    tg.close();
                });
            } catch(e) { console.error("Cheat/Ban error", e); }
        }
    });

    // --- ðŸ“¢ BROADCAST (REAL VAQTDA XABAR) ---
    function setupBroadcast() {
        onSnapshot(doc(db, "settings", "announcement"), (snap) => {
            if (snap.exists()) {
                const data = snap.data();
                tg.showPopup({
                    title: 'ðŸ“¢ Admin xabari',
                    message: data.text,
                    buttons: [{type: 'ok', text: 'Yopish'}]
                });
            }
        });
    }

    // --- REAL VAQTDA BLOKLASHNI TEKSHIRISH ---
    function setupRealtimeBan() {
        if(userId === "guest") return;
        const banRef = doc(db, "banned_users", userId);
        onSnapshot(banRef, (snap) => {
            if(snap.exists()) {
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('ban-overlay').style.display = 'flex';
                if(timerInt) clearInterval(timerInt);
            } else {
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('ban-overlay').style.display = 'none';
            }
        });
    }

    window.toggleDarkMode = () => {
        const isDark = document.getElementById('theme-toggle').checked;
        document.body.classList.toggle('dark', isDark);
        localStorage.setItem('quizDarkMode', isDark);
    };
    if(localStorage.getItem('quizDarkMode') === 'true') {
        document.body.classList.add('dark');
        document.getElementById('theme-toggle').checked = true;
    }

    async function loadData() {
        const snap = await getDocs(collection(db, "savollar"));
        let list = [];
        snap.forEach(d => list.push({ ...d.data(), id: d.id }));
        allQs = list.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
    }

    window.nav = (id, el) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(el) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }
    };

    window.startMode = async (m) => {
        if(allQs.length === 0) await loadData();
        mode = m; curIdx = 0; userAnswers = []; isFinished = false;
        if(mode === 'real') {
            currentQs = [...allQs].sort(() => 0.5 - Math.random()).slice(0, 35);
            startTimer(30 * 60);
        } else {
            currentQs = [...allQs];
            clearInterval(timerInt);
            document.getElementById('timer-label').innerText = "ðŸ“– O'quv";
        }
        nav('quiz-screen');
        render();
    };

    function startTimer(sec) {
        clearInterval(timerInt);
        timerInt = setInterval(() => {
            let m = Math.floor(sec/60), s = sec%60;
            document.getElementById('timer-label').innerText = `${m}:${s<10?'0':''}${s}`;
            if(--sec < 0) finish();
        }, 1000);
    }

    function formatContent(content) {
        if (content && typeof content === 'string' && content.startsWith('data:image')) {
            return `<img src="${content}">`;
        }
        return content;
    }

    function render() {
        if(curIdx >= currentQs.length) { finish(); return; }
        const q = currentQs[curIdx];
        document.getElementById('counter-label').innerText = `${curIdx+1}/${currentQs.length}`;
        document.getElementById('q-text').innerText = q.text;
        document.getElementById('btn-next-step').style.display = 'none';
        
        const qImg = document.getElementById('q-image');
        if (q.image && q.image.startsWith('data:image')) {
            qImg.src = q.image;
            qImg.style.display = 'block';
        } else {
            qImg.style.display = 'none';
        }
        
        const box = document.getElementById('options-box'); box.innerHTML = '';
        const correctVal = q.variants[0];
        let opts = [...q.variants].sort(() => 0.5 - Math.random());
        
        opts.forEach(opt => {
            const b = document.createElement('button');
            b.className = 'option'; 
            b.innerHTML = formatContent(opt);
            
            b.onclick = async () => {
                if (mode === 'all') {
                    const allBtns = box.querySelectorAll('.option');
                    allBtns.forEach(btn => btn.disabled = true);
                    if(opt === correctVal) { b.classList.add('correct'); } 
                    else { 
                        b.classList.add('wrong'); 
                        allBtns.forEach(btn => {
                            if(btn.innerHTML === formatContent(correctVal)) btn.classList.add('correct');
                        }); 
                    }
                    userAnswers.push({q: q.text, s: opt, c: correctVal});
                    document.getElementById('btn-next-step').style.display = 'block';
                } else {
                    userAnswers.push({q: q.text, s: opt, c: correctVal});
                    curIdx++;
                    render();
                }
            };
            box.appendChild(b);
        });
    }

    window.next = () => { curIdx++; render(); };

    async function finish() {
        if (isFinished) return; isFinished = true;
        clearInterval(timerInt);
        const total = currentQs.length;
        const correct = userAnswers.filter(a => a.s === a.c).length;
        const score = correct * 2;
        const per = Math.round((correct/total)*100);

        nav('page-result');
        document.getElementById('res-status').innerText = per >= 50 ? "Ajoyib! ðŸŽ‰" : "Yana o'qing! ðŸ“š";
        document.getElementById('res-text').innerHTML = `Natija: <b style="color:var(--p)">${correct}/${total}</b><br>Ball: <b>${score} ball</b><br>Ko'rsatkich: <b>${per}%</b>`;

        if(per >= 80 && mode === 'real') {
            confetti({particleCount: 150, spread: 70});
            generateCertificate(userName, per);
        }

        if(mode === 'real' && userId !== 'guest') {
            const botText = `ðŸ† *YANGI NATIJA* ðŸ†%0A%0AðŸ‘¤ *Talaba:* ${userName}%0Aâœ… *Natija:* ${correct} / ${total}%0AðŸ“Š *Ball:* ${score} ball%0AðŸ“ˆ *Ko'rsatkich:* ${per}%25`;
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${GROUP_ID}&text=${botText}&parse_mode=markdown`)
            .catch(e => console.error("Telegram error:", e));
            
            const userRef = doc(db, "reyting", userId.toString());
            const userDoc = await getDoc(userRef);
            if(!userDoc.exists() || score > userDoc.data().score) {
                await setDoc(userRef, {name: userName, score: score, updatedAt: serverTimestamp()}, {merge: true});
            }
        }
    }

    function generateCertificate(name, score) {
        const canvas = document.getElementById('cert-canvas');
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, 800, 560);
        ctx.strokeStyle = '#4f46e5'; ctx.lineWidth = 15; ctx.strokeRect(10, 10, 780, 540);
        ctx.fillStyle = '#1f2937'; ctx.textAlign = 'center';
        ctx.font = 'bold 40px Serif'; ctx.fillText('SERTIFIKAT', 400, 100);
        ctx.font = 'italic bold 50px Serif'; ctx.fillStyle = '#4f46e5'; ctx.fillText(name, 400, 260);
        ctx.font = '25px Sans-serif'; ctx.fillStyle = '#1f2937';
        ctx.fillText(`${score}% natija bilan muvaffaqiyatli o'tdi.`, 400, 360);
        document.getElementById('cert-display').src = canvas.toDataURL("image/png");
        document.getElementById('cert-area').style.display = 'block';
    }

    window.downloadCert = () => {
        const link = document.createElement('a');
        link.download = `cert_${userName}.png`;
        link.href = document.getElementById('cert-display').src;
        link.click();
    };

    window.showReview = () => {
        nav('page-review');
        const list = document.getElementById('review-list'); list.innerHTML = '';
        userAnswers.forEach(a => {
            list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; margin-bottom:10px;"><b>${a.q}</b><br><span style="color:green">To'g'ri: ${formatContent(a.c)}</span>${a.s!==a.c ? `<br><span style="color:red">Siz: ${formatContent(a.s)}</span>`:''}</div>`;
        });
    };

    window.loadRankings = async () => {
        const q = query(collection(db, "reyting"), orderBy("score", "desc"), limit(10));
        const snap = await getDocs(q);
        const container = document.getElementById('rank-container'); container.innerHTML = '';
        let i = 1;
        snap.forEach(d => {
            container.innerHTML += `<div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid rgba(0,0,0,0.05);"><span>${i++}. ${d.data().name}</span><b>${d.data().score} ball</b></div>`;
        });
    };

    // ILOVA YUKLANGANDA
    setupRealtimeBan();
    setupBroadcast();
    loadData();
</script>
</body>
</html>
