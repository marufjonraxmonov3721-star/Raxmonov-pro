<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raxmonov Save Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0b0f1a; color: white; font-family: sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .v-card { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4">
    <h1 class="text-xl font-bold text-blue-500 italic mb-6">RAXMONOV SAVE</h1>

    <div class="flex gap-2 mb-6 sticky top-0 bg-[#0b0f1a] py-2 z-50">
        <input type="text" id="searchInput" placeholder="Musiqa nomi..." class="flex-1 p-4 rounded-2xl bg-gray-900 border border-gray-800 outline-none text-sm focus:border-blue-500 transition-all text-white">
        <button onclick="sendSearchToBot()" class="bg-blue-600 w-14 h-14 rounded-2xl flex items-center justify-center active:scale-95"><i class="fas fa-search"></i></button>
    </div>

    <div id="resultsContainer" class="space-y-4 pb-20">
        <div id="statusText" class="text-center text-gray-600 mt-20 italic">Qidiruv natijalari shu yerda chiqadi.</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
            authDomain: "gen-lang-client-0228947349.firebaseapp.com",
            databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
            projectId: "gen-lang-client-0228947349",
            appId: "1:253793341504:web:709752258000dab44fcfa5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Foydalanuvchi ID bo'yicha bazani tinglash
        if (tg.initDataUnsafe.user) {
            const userId = tg.initDataUnsafe.user.id;
            onValue(ref(db, `search_results/${userId}`), (snapshot) => {
                const data = snapshot.val();
                if (data && data.items) {
                    renderItems(data.items);
                }
            });
        }

        window.sendSearchToBot = () => {
            const q = document.getElementById('searchInput').value;
            if(!q) return;
            document.getElementById('statusText').innerText = "Bot qidirmoqda...";
            // Ilovani yopmasdan ma'lumot yuborish (bu faqat botga message yuboradi)
            tg.sendData(JSON.stringify({action: "live_search", query: q}));
        };

        function renderItems(items) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = "glass p-3 rounded-3xl v-card flex gap-4 items-center";
                card.innerHTML = `
                    <img src="${item.thumb}" class="w-24 h-16 rounded-xl object-cover">
                    <div class="flex-1 overflow-hidden">
                        <h3 class="text-[11px] font-bold truncate mb-2">${item.title}</h3>
                        <div class="flex gap-2">
                            <button onclick="download('${item.id}', 'mp3')" class="bg-blue-600/20 text-blue-400 text-[10px] font-bold px-3 py-2 rounded-xl flex-1">MP3</button>
                            <button onclick="download('${item.id}', 'mp4')" class="bg-green-600/20 text-green-400 text-[10px] font-bold px-3 py-2 rounded-xl flex-1">MP4</button>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
        }

        window.download = (id, type) => {
            tg.sendData(JSON.stringify({action: "download", type: type, url: `https://youtu.be/${id}`}));
            tg.close();
        };
    </script>
</body>
</html>
